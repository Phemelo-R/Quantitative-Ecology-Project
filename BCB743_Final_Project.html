<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shane Ngwenya">
<meta name="author" content="Phemelo Rutlokoane">
<meta name="author" content="Kezia Samuels">
<meta name="dcterms.date" content="2025-06-17">

<title>BCB743 Final Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="BCB743_Final_Project_files/libs/clipboard/clipboard.min.js"></script>
<script src="BCB743_Final_Project_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="BCB743_Final_Project_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="BCB743_Final_Project_files/libs/quarto-html/popper.min.js"></script>
<script src="BCB743_Final_Project_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="BCB743_Final_Project_files/libs/quarto-html/anchor.min.js"></script>
<link href="BCB743_Final_Project_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="BCB743_Final_Project_files/libs/quarto-html/quarto-syntax-highlighting-662ae1889177880cb371f83234c0a158.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="BCB743_Final_Project_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="BCB743_Final_Project_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="BCB743_Final_Project_files/libs/bootstrap/bootstrap-228c7a1f6fefb0919955476d4be2e7a1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="LesCodex.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#loading-libraries" id="toc-loading-libraries" class="nav-link active" data-scroll-target="#loading-libraries">Loading Libraries</a></li>
  <li><a href="#biological-data-acquisition-and-processing-shane-ngwenya" id="toc-biological-data-acquisition-and-processing-shane-ngwenya" class="nav-link" data-scroll-target="#biological-data-acquisition-and-processing-shane-ngwenya">1. Biological Data acquisition and processing (Shane Ngwenya)</a>
  <ul class="collapse">
  <li><a href="#defining-study-site-extent-with-centroids" id="toc-defining-study-site-extent-with-centroids" class="nav-link" data-scroll-target="#defining-study-site-extent-with-centroids">Defining study site extent with centroids</a></li>
  <li><a href="#pre-processing-the-raw-adder-data" id="toc-pre-processing-the-raw-adder-data" class="nav-link" data-scroll-target="#pre-processing-the-raw-adder-data">Pre-processing the raw adder data</a></li>
  <li><a href="#collecting-biome-bioregion-and-vegetation-data" id="toc-collecting-biome-bioregion-and-vegetation-data" class="nav-link" data-scroll-target="#collecting-biome-bioregion-and-vegetation-data">Collecting biome, bioregion, and vegetation data</a></li>
  </ul></li>
  <li><a href="#environmental-data-sourcing-and-extraction-phemelo-rutlokoane" id="toc-environmental-data-sourcing-and-extraction-phemelo-rutlokoane" class="nav-link" data-scroll-target="#environmental-data-sourcing-and-extraction-phemelo-rutlokoane">2. Environmental data sourcing and extraction (Phemelo Rutlokoane)</a>
  <ul class="collapse">
  <li><a href="#loading-all-the-environmental-rasters-required" id="toc-loading-all-the-environmental-rasters-required" class="nav-link" data-scroll-target="#loading-all-the-environmental-rasters-required">Loading all the environmental rasters required</a></li>
  <li><a href="#calculate-true-ndvi-by-applying-scale-factor-and-offset" id="toc-calculate-true-ndvi-by-applying-scale-factor-and-offset" class="nav-link" data-scroll-target="#calculate-true-ndvi-by-applying-scale-factor-and-offset">Calculate true NDVI by applying scale factor and offset</a></li>
  <li><a href="#extract-raster-values-for-each-centroid" id="toc-extract-raster-values-for-each-centroid" class="nav-link" data-scroll-target="#extract-raster-values-for-each-centroid">Extract raster values for each centroid</a></li>
  <li><a href="#cleaning-the-data-and-making-it-neat" id="toc-cleaning-the-data-and-making-it-neat" class="nav-link" data-scroll-target="#cleaning-the-data-and-making-it-neat">Cleaning the data and making it neat</a></li>
  <li><a href="#adding-and-preparing-the-land-cover-data" id="toc-adding-and-preparing-the-land-cover-data" class="nav-link" data-scroll-target="#adding-and-preparing-the-land-cover-data">Adding and preparing the land cover data</a></li>
  <li><a href="#grouping-the-land-cover-by-classification-group" id="toc-grouping-the-land-cover-by-classification-group" class="nav-link" data-scroll-target="#grouping-the-land-cover-by-classification-group">Grouping the land cover by classification group</a></li>
  <li><a href="#pre-process-for-merging-to-environmental-data" id="toc-pre-process-for-merging-to-environmental-data" class="nav-link" data-scroll-target="#pre-process-for-merging-to-environmental-data">Pre-process for merging to environmental data</a></li>
  <li><a href="#sum-histogram-by-class-group" id="toc-sum-histogram-by-class-group" class="nav-link" data-scroll-target="#sum-histogram-by-class-group">Sum histogram by class group</a></li>
  <li><a href="#add-coordinates-to-land-cover-data" id="toc-add-coordinates-to-land-cover-data" class="nav-link" data-scroll-target="#add-coordinates-to-land-cover-data">Add coordinates to land cover data</a></li>
  <li><a href="#prepare-coordinate-matrices-for-matching" id="toc-prepare-coordinate-matrices-for-matching" class="nav-link" data-scroll-target="#prepare-coordinate-matrices-for-matching">Prepare coordinate matrices for matching</a></li>
  <li><a href="#find-nearest-neighbour-matches" id="toc-find-nearest-neighbour-matches" class="nav-link" data-scroll-target="#find-nearest-neighbour-matches">Find nearest neighbour matches</a></li>
  <li><a href="#calculate-proportions" id="toc-calculate-proportions" class="nav-link" data-scroll-target="#calculate-proportions">Calculate proportions</a></li>
  </ul></li>
  <li><a href="#data-analysis-and-visualisation-kezia-samuels" id="toc-data-analysis-and-visualisation-kezia-samuels" class="nav-link" data-scroll-target="#data-analysis-and-visualisation-kezia-samuels">3. Data analysis and visualisation (Kezia Samuels)</a>
  <ul class="collapse">
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data">Load the data</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling">Data wrangling</a></li>
  <li><a href="#separate-the-environmental-dataset" id="toc-separate-the-environmental-dataset" class="nav-link" data-scroll-target="#separate-the-environmental-dataset">Separate the environmental dataset</a></li>
  <li><a href="#correlation-analyses" id="toc-correlation-analyses" class="nav-link" data-scroll-target="#correlation-analyses">Correlation analyses</a></li>
  <li><a href="#variable-inflation-factor-vif" id="toc-variable-inflation-factor-vif" class="nav-link" data-scroll-target="#variable-inflation-factor-vif">Variable Inflation Factor (VIF)</a></li>
  <li><a href="#pca" id="toc-pca" class="nav-link" data-scroll-target="#pca">PCA</a></li>
  <li><a href="#cca" id="toc-cca" class="nav-link" data-scroll-target="#cca">CCA</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BCB743 Final Project</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Shane Ngwenya </p>
             <p><a href="https://github.com/Phemelo-R" target="_blank">Phemelo Rutlokoane</a> </p>
             <p>Kezia Samuels </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 17, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="loading-libraries" class="level2">
<h2 class="anchored" data-anchor-id="loading-libraries">Loading Libraries</h2>
<p>This section involves loading all the necessary libraries that have been used in this project. They do not necessarily apply to just the first section of this project.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)    <span class="co"># For data manipulation and visualization</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(sf)           <span class="co"># For working with spatial data</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(terra)        <span class="co"># For working with spatial data and rasters</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(geodata)      <span class="co"># For downloading and working with geospatial data</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(FNN)          <span class="co"># For nearest neighbour matching</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">library</span>(vegan)        <span class="co"># For ecological data analysis</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">library</span>(readxl)       <span class="co"># For reading Excel files</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="fu">library</span>(corrplot)     <span class="co"># For visualising correlations</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">library</span>(ggcorrplot)   <span class="co"># For visualising correlations</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="fu">library</span>(ggpubr)       <span class="co"># For combining ggplots</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="fu">library</span>(Hmisc)        <span class="co"># for rcorr </span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="fu">library</span>(cluster)      <span class="co"># For clustering analysis</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="fu">library</span>(readr)        <span class="co"># For reading CSV files</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="fu">library</span>(ggrepel)      <span class="co"># For better text labels in ggplot</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="fu">library</span>(viridis)      <span class="co"># For colour palettes</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="fu">library</span>(usdm)         <span class="co"># For variance inflation factor (VIF) calculations</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="fu">library</span>(tibble)       <span class="co"># For tibbles</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="fu">library</span>(colorspace)   <span class="co"># For colour manipulation</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="fu">library</span>(reshape2)     <span class="co"># For reshaping data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="biological-data-acquisition-and-processing-shane-ngwenya" class="level2">
<h2 class="anchored" data-anchor-id="biological-data-acquisition-and-processing-shane-ngwenya">1. Biological Data acquisition and processing (Shane Ngwenya)</h2>
<section id="defining-study-site-extent-with-centroids" class="level3">
<h3 class="anchored" data-anchor-id="defining-study-site-extent-with-centroids">Defining study site extent with centroids</h3>
<p>The first step involves making a 0.25° × 0.25° (15′ × 15′) latitude–longitude grid for South Africa, which will be our study area for the project.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Define bounding box for South Africa</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>xmin <span class="ot">&lt;-</span> <span class="dv">16</span>     <span class="co"># degrees East</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>xmax <span class="ot">&lt;-</span> <span class="dv">33</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>ymin <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">35</span>    <span class="co"># degrees South</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>ymax <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">22</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># Create grid with 0.25° resolution (quarter-degree)</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(</span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="at">cellsize =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.25</span>),</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="at">offset   =</span> <span class="fu">c</span>(xmin, ymin),</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="at">n        =</span> <span class="fu">c</span>((xmax <span class="sc">-</span> xmin) <span class="sc">/</span> <span class="fl">0.25</span>, (ymax <span class="sc">-</span> ymin) <span class="sc">/</span> <span class="fl">0.25</span>),</span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="at">crs      =</span> <span class="dv">4326</span>,        <span class="co"># WGS 84 coordinate reference system</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="at">what     =</span> <span class="st">"polygons"</span>   <span class="co"># Create polygons for each grid cell</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that the grids have been created, we now create centroids for each grid cell to extract the coordinates and create sites based off the centroids:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Compute centroids of each grid cell</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>centroids <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(grid)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># Convert to data frame and add coordinates and cell_id</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>centroids_df <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(centroids) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="fu">mutate</span>(<span class="at">cell_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="at">lon_centroid =</span> <span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>],</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="at">lat_centroid =</span> <span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]</span>
<span id="cb3-10"><a href="#cb3-10"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co"># 5. Export centroids as CSV</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="fu">write.csv</span>(</span>
<span id="cb3-15"><a href="#cb3-15"></a>  centroids_df,</span>
<span id="cb3-16"><a href="#cb3-16"></a>  <span class="st">"SA Quarter Degree Centroids.csv"</span>,</span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="pre-processing-the-raw-adder-data" class="level3">
<h3 class="anchored" data-anchor-id="pre-processing-the-raw-adder-data">Pre-processing the raw adder data</h3>
<p>This one will wait until Shane goes back to the lab. Until then, we move…</p>
<hr>
</section>
<section id="collecting-biome-bioregion-and-vegetation-data" class="level3">
<h3 class="anchored" data-anchor-id="collecting-biome-bioregion-and-vegetation-data">Collecting biome, bioregion, and vegetation data</h3>
<p>This step involved extracting biome data from the South African Vegetation Map. However, in order to do that, we first had to convert our centroid points into sf point layers</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Read your centroids CSV</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>centroids <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"SA Quarter Degree Centroids.csv"</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># Convert to an sf POINT layer (WGS84)</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb4-6"><a href="#cb4-6"></a>  centroids,</span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon_centroid"</span>,<span class="st">"lat_centroid"</span>),</span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="at">crs    =</span> <span class="dv">4326</span>,</span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>)</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co"># Read the VegMap shapefile (native CRS)</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>veg <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"QGIS/Shapefile/NVM2024Final_IEM5_12_07012025.shp"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-14"><a href="#cb4-14"></a></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co"># Repair invalid polygons:</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># Try sf’s built-in make_valid (requires GEOS ≥ 3.6):</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>veg <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(veg)</span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co"># If that still errors, you can fall back to the “buffer zero” hack:</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co"># veg &lt;- st_buffer(veg, 0)</span></span>
<span id="cb4-21"><a href="#cb4-21"></a></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co"># Reproject the cleaned VegMap to match pts (EPSG:4326)</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>veg <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(veg, <span class="fu">st_crs</span>(pts))</span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co"># Select only the vegetation fields you need</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>veg_sel <span class="ot">&lt;-</span> veg <span class="sc">%&gt;%</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb4-28"><a href="#cb4-28"></a>    <span class="at">biome     =</span> T_BIOME,</span>
<span id="cb4-29"><a href="#cb4-29"></a>    <span class="at">bioregion =</span> T_BIOREGIO,</span>
<span id="cb4-30"><a href="#cb4-30"></a>    <span class="at">veg_type  =</span> T_Name</span>
<span id="cb4-31"><a href="#cb4-31"></a>  )</span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co"># Spatial join: attach veg attributes to each centroid</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>pts_veg <span class="ot">&lt;-</span> <span class="fu">st_join</span>(</span>
<span id="cb4-35"><a href="#cb4-35"></a>  pts,</span>
<span id="cb4-36"><a href="#cb4-36"></a>  veg_sel,</span>
<span id="cb4-37"><a href="#cb4-37"></a>  <span class="at">join =</span> st_intersects,</span>
<span id="cb4-38"><a href="#cb4-38"></a>  <span class="at">left =</span> <span class="cn">TRUE</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>)</span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co"># Drop geometry and keep just the columns you want</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>out <span class="ot">&lt;-</span> pts_veg <span class="sc">%&gt;%</span></span>
<span id="cb4-43"><a href="#cb4-43"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb4-45"><a href="#cb4-45"></a>    cell_id,</span>
<span id="cb4-46"><a href="#cb4-46"></a>    lon_centroid,</span>
<span id="cb4-47"><a href="#cb4-47"></a>    lat_centroid,</span>
<span id="cb4-48"><a href="#cb4-48"></a>    biome,</span>
<span id="cb4-49"><a href="#cb4-49"></a>    bioregion,</span>
<span id="cb4-50"><a href="#cb4-50"></a>    veg_type</span>
<span id="cb4-51"><a href="#cb4-51"></a>  )</span>
<span id="cb4-52"><a href="#cb4-52"></a></span>
<span id="cb4-53"><a href="#cb4-53"></a><span class="co"># Write to CSV</span></span>
<span id="cb4-54"><a href="#cb4-54"></a><span class="fu">write.csv</span>(</span>
<span id="cb4-55"><a href="#cb4-55"></a>  out,</span>
<span id="cb4-56"><a href="#cb4-56"></a>  <span class="st">"centroids_with_vegtype.csv"</span>,</span>
<span id="cb4-57"><a href="#cb4-57"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb4-58"><a href="#cb4-58"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="environmental-data-sourcing-and-extraction-phemelo-rutlokoane" class="level2">
<h2 class="anchored" data-anchor-id="environmental-data-sourcing-and-extraction-phemelo-rutlokoane">2. Environmental data sourcing and extraction (Phemelo Rutlokoane)</h2>
<section id="loading-all-the-environmental-rasters-required" class="level3">
<h3 class="anchored" data-anchor-id="loading-all-the-environmental-rasters-required">Loading all the environmental rasters required</h3>
<p>In this section we are going to load all the raster data we downloaded from WorldClim as well as the centroid points we made in the first section. I also added the NDVI raster I clipped from QGIS. All the raster files loaded in this section were projected in QGIS to EPSG:4326 (WGS 84) so that the crs matches that of the biological data and centroids.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Load grid centroids</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>points <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Project_workplan/SA Quarter Degree Centroids.csv"</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co"># Load environmental rasters</span></span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co"># Mean Annual precipitation</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>MeanPrecip_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Precip/SA_MeanPrecip.tif"</span>) </span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># Precipitation of driest quarter</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>DryPrecip_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Precip/SA_Precip_DryQ.tif"</span>)</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co"># Precipitation of wettest quarter</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>WetPrecip_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Precip/SA_Precip_WetQ.tif"</span>)  </span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co"># Precipitation Seasonality (Coefficient of Variation)</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>SeaPrecip_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Precip/SA_Precip_Seasonality.tif"</span>) </span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co"># Elevation of South Africa</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>Elevation_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Elev/SA_Elev.tif"</span>)</span>
<span id="cb5-19"><a href="#cb5-19"></a></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co"># Mean Annual Temperature</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>MeanTemp_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Temp/SA_Mean_Temp.tif"</span>)</span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="co"># Maximum Temperature of warmest month</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>HotTemp_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Temp/SA_MaxTemp.tif"</span>) </span>
<span id="cb5-25"><a href="#cb5-25"></a></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="co"># Minimum Temperature of coldest month</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>ColdTemp_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Temp/SA_MinTemp.tif"</span>)  </span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="co"># Mean Diurnal Range (Mean of monthly (max temp - min temp))</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>DiurnalTemp_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_Temp/Mean_Diurnal_RangeTemp.tif"</span>) </span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="co"># Normalised Difference Vegetation Index</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>NDVI_raster_raw <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_NDVI/SA_NDVI_merge.tif"</span>)     </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="calculate-true-ndvi-by-applying-scale-factor-and-offset" class="level3">
<h3 class="anchored" data-anchor-id="calculate-true-ndvi-by-applying-scale-factor-and-offset">Calculate true NDVI by applying scale factor and offset</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Inspect the NDVI metadata</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>meta <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">sources</span>(NDVI_raster_raw)  <span class="co"># Extract metadata</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co"># Get raw metadata</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>terra<span class="sc">::</span><span class="fu">describe</span>(<span class="st">"Project_workplan/SA_NDVI/SA_NDVI_merge.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Driver: GTiff/GeoTIFF"                                                    
 [2] "Files: Project_workplan/SA_NDVI/SA_NDVI_merge.tif"                        
 [3] "       Project_workplan/SA_NDVI/SA_NDVI_merge.tif.aux.xml"                
 [4] "Size is 8851, 6099"                                                       
 [5] "Coordinate System is:"                                                    
 [6] "GEOGCRS[\"WGS 84\","                                                      
 [7] "    ENSEMBLE[\"World Geodetic System 1984 ensemble\","                    
 [8] "        MEMBER[\"World Geodetic System 1984 (Transit)\"],"                
 [9] "        MEMBER[\"World Geodetic System 1984 (G730)\"],"                   
[10] "        MEMBER[\"World Geodetic System 1984 (G873)\"],"                   
[11] "        MEMBER[\"World Geodetic System 1984 (G1150)\"],"                  
[12] "        MEMBER[\"World Geodetic System 1984 (G1674)\"],"                  
[13] "        MEMBER[\"World Geodetic System 1984 (G1762)\"],"                  
[14] "        MEMBER[\"World Geodetic System 1984 (G2139)\"],"                  
[15] "        MEMBER[\"World Geodetic System 1984 (G2296)\"],"                  
[16] "        ELLIPSOID[\"WGS 84\",6378137,298.257223563,"                      
[17] "            LENGTHUNIT[\"metre\",1]],"                                    
[18] "        ENSEMBLEACCURACY[2.0]],"                                          
[19] "    PRIMEM[\"Greenwich\",0,"                                              
[20] "        ANGLEUNIT[\"degree\",0.0174532925199433]],"                       
[21] "    CS[ellipsoidal,2],"                                                   
[22] "        AXIS[\"geodetic latitude (Lat)\",north,"                          
[23] "            ORDER[1],"                                                    
[24] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"                   
[25] "        AXIS[\"geodetic longitude (Lon)\",east,"                          
[26] "            ORDER[2],"                                                    
[27] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"                   
[28] "    USAGE["                                                               
[29] "        SCOPE[\"Horizontal component of 3D system.\"],"                   
[30] "        AREA[\"World.\"],"                                                
[31] "        BBOX[-90,-180,90,180]],"                                          
[32] "    ID[\"EPSG\",4326]]"                                                   
[33] "Data axis to CRS axis mapping: 2,1"                                       
[34] "Origin = (16.453029225000002,-22.127083331000001)"                        
[35] "Pixel Size = (0.001863282887809,-0.002083333333169)"                      
[36] "Metadata:"                                                                
[37] "  AREA_OR_POINT=Area"                                                     
[38] "Image Structure Metadata:"                                                
[39] "  INTERLEAVE=BAND"                                                        
[40] "Corner Coordinates:"                                                      
[41] "Upper Left  (  16.4530292, -22.1270833) ( 16d27'10.91\"E, 22d 7'37.50\"S)"
[42] "Lower Left  (  16.4530292, -34.8333333) ( 16d27'10.91\"E, 34d50' 0.00\"S)"
[43] "Upper Right (  32.9449461, -22.1270833) ( 32d56'41.81\"E, 22d 7'37.50\"S)"
[44] "Lower Right (  32.9449461, -34.8333333) ( 32d56'41.81\"E, 34d50' 0.00\"S)"
[45] "Center      (  24.6989876, -28.4802083) ( 24d41'56.36\"E, 28d28'48.75\"S)"
[46] "Band 1 Block=8851x1 Type=Float32, ColorInterp=Gray"                       
[47] "  Min=-19460000.000 Max=98290000.000 "                                    
[48] "  Metadata:"                                                              
[49] "    STATISTICS_APPROXIMATE=YES"                                           
[50] "    STATISTICS_MAXIMUM=98290000"                                          
[51] "    STATISTICS_MEAN=21646048.576361"                                      
[52] "    STATISTICS_MINIMUM=-19460000"                                         
[53] "    STATISTICS_STDDEV=23304939.786871"                                    
[54] "    STATISTICS_VALID_PERCENT=100"                                         </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Apply scale factor</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>NDVI_raster <span class="ot">&lt;-</span> NDVI_raster_raw <span class="sc">*</span> <span class="fl">0.00000001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
|---------|---------|---------|---------|
=========================================
                                          </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Verify range after scaling</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">global</span>(NDVI_raster, range, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># Should be between -1 and +1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                X1     X2
SA_NDVI_merge -0.2 0.9992</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># Mask invalid pixels</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>NDVI_raster[NDVI_raster <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">|</span> NDVI_raster <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
|---------|---------|---------|---------|
=========================================
                                          

|---------|---------|---------|---------|
=========================================
                                          

|---------|---------|---------|---------|
=========================================
                                          

|---------|---------|---------|---------|
=========================================
                                          </code></pre>
</div>
</div>
<hr>
</section>
<section id="extract-raster-values-for-each-centroid" class="level3">
<h3 class="anchored" data-anchor-id="extract-raster-values-for-each-centroid">Extract raster values for each centroid</h3>
<p>In order to accomplish this, we first have to convert our centroids into sf objects that will be able to extract the values of the environmental rasters properly and accurately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Convert to sf object</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>points_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(points, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon_centroid"</span>, <span class="st">"lat_centroid"</span>), <span class="at">crs =</span> <span class="dv">4326</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co"># Extract mean annual precipitation value for each point</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>MeanPrecip <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(MeanPrecip_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-6"><a href="#cb14-6"></a></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co"># Extract precipitation of driest quarter value for each point</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>DryPrecip <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(DryPrecip_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-9"><a href="#cb14-9"></a></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co"># Extract precipitation of wettest quarter value for each point</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>WetPrecip <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(WetPrecip_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-12"><a href="#cb14-12"></a></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="co"># Extract precipitation seasonality (coefficient of variation value for each point</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>SeasonPrecip <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(SeaPrecip_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-15"><a href="#cb14-15"></a></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="co"># Extract elevation value for each point</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>Elevation <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(Elevation_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-18"><a href="#cb14-18"></a></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="co"># Extract NDVI value for each point</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>NDVI <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(NDVI_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-21"><a href="#cb14-21"></a></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="co"># Extract mean annual temperature value for each point</span></span>
<span id="cb14-23"><a href="#cb14-23"></a>MeanTemp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(MeanTemp_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-24"><a href="#cb14-24"></a></span>
<span id="cb14-25"><a href="#cb14-25"></a><span class="co"># Extract maximum temperature for hottest month value for each point</span></span>
<span id="cb14-26"><a href="#cb14-26"></a>MaxTemp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(HotTemp_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-27"><a href="#cb14-27"></a></span>
<span id="cb14-28"><a href="#cb14-28"></a><span class="co"># Extract minimum temperature for coldest month value for each point</span></span>
<span id="cb14-29"><a href="#cb14-29"></a>MinTemp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(ColdTemp_raster, <span class="fu">vect</span>(points_sf))</span>
<span id="cb14-30"><a href="#cb14-30"></a></span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="co"># Extract mean diurnal range value for each point</span></span>
<span id="cb14-32"><a href="#cb14-32"></a>DiurnalTemp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(DiurnalTemp_raster, <span class="fu">vect</span>(points_sf))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cleaning-the-data-and-making-it-neat" class="level3">
<h3 class="anchored" data-anchor-id="cleaning-the-data-and-making-it-neat">Cleaning the data and making it neat</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># Join data into one table </span></span>
<span id="cb15-2"><a href="#cb15-2"></a>Environmental_variables <span class="ot">&lt;-</span> <span class="fu">cbind</span>(points_sf, MeanPrecip, DryPrecip, WetPrecip, SeasonPrecip, Elevation, NDVI, MeanTemp, MaxTemp, MinTemp, DiurnalTemp)</span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co"># Convert environmental_variables from sf into data frame</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>Environmental_variables <span class="ot">&lt;-</span>  <span class="fu">as.data.frame</span>(Environmental_variables)</span>
<span id="cb15-6"><a href="#cb15-6"></a></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co"># Select wanted columns</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>Env_var <span class="ot">&lt;-</span> Environmental_variables <span class="sc">|&gt;</span> </span>
<span id="cb15-9"><a href="#cb15-9"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(cell_id, lon_centroid, lat_centroid, SA_MeanPrecip, SA_Precip_DryQ, SA_Precip_WetQ, SA_Precip_Seasonality, SA_Elev, SA_NDVI_merge, SA_Mean_Temp, SA_MaxTemp, SA_MinTemp, Mean_Diurnal_RangeTemp)</span>
<span id="cb15-10"><a href="#cb15-10"></a></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="co"># Rename the columns</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>Env_var <span class="ot">&lt;-</span> Env_var <span class="sc">|&gt;</span> </span>
<span id="cb15-13"><a href="#cb15-13"></a>  <span class="fu">rename</span>(</span>
<span id="cb15-14"><a href="#cb15-14"></a>    <span class="at">lon            =</span> lon_centroid,</span>
<span id="cb15-15"><a href="#cb15-15"></a>    <span class="at">lat            =</span> lat_centroid,</span>
<span id="cb15-16"><a href="#cb15-16"></a>    <span class="at">MeanPrecip     =</span> SA_MeanPrecip,</span>
<span id="cb15-17"><a href="#cb15-17"></a>    <span class="at">DryPrecip      =</span> SA_Precip_DryQ,</span>
<span id="cb15-18"><a href="#cb15-18"></a>    <span class="at">WetPrecip      =</span> SA_Precip_WetQ,</span>
<span id="cb15-19"><a href="#cb15-19"></a>    <span class="at">SeasonalPrecip =</span> SA_Precip_Seasonality,</span>
<span id="cb15-20"><a href="#cb15-20"></a>    <span class="at">Elevation      =</span> SA_Elev,</span>
<span id="cb15-21"><a href="#cb15-21"></a>    <span class="at">NDVI           =</span> SA_NDVI_merge,</span>
<span id="cb15-22"><a href="#cb15-22"></a>    <span class="at">MeanTemp       =</span> SA_Mean_Temp,</span>
<span id="cb15-23"><a href="#cb15-23"></a>    <span class="at">MaxTemp        =</span> SA_MaxTemp,</span>
<span id="cb15-24"><a href="#cb15-24"></a>    <span class="at">MinTemp        =</span> SA_MinTemp,</span>
<span id="cb15-25"><a href="#cb15-25"></a>    <span class="at">DiurnalTemp    =</span> Mean_Diurnal_RangeTemp</span>
<span id="cb15-26"><a href="#cb15-26"></a>  )</span>
<span id="cb15-27"><a href="#cb15-27"></a></span>
<span id="cb15-28"><a href="#cb15-28"></a><span class="co"># Arrange cell_id in descending order</span></span>
<span id="cb15-29"><a href="#cb15-29"></a>Env_var <span class="ot">&lt;-</span> Env_var <span class="sc">|&gt;</span> </span>
<span id="cb15-30"><a href="#cb15-30"></a>  <span class="fu">arrange</span>(cell_id)</span>
<span id="cb15-31"><a href="#cb15-31"></a></span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="co"># Remove cell_id "159" and "3394" because they have NA values</span></span>
<span id="cb15-33"><a href="#cb15-33"></a>Env_var <span class="ot">&lt;-</span> Env_var <span class="sc">|&gt;</span> </span>
<span id="cb15-34"><a href="#cb15-34"></a>  <span class="fu">filter</span>(<span class="sc">!</span>cell_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"159"</span>,<span class="st">"3394"</span>))</span>
<span id="cb15-35"><a href="#cb15-35"></a></span>
<span id="cb15-36"><a href="#cb15-36"></a><span class="co"># Save the table as a .csv file</span></span>
<span id="cb15-37"><a href="#cb15-37"></a><span class="fu">write.csv</span>(Env_var, <span class="st">"Project_workplan/Env_var.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="adding-and-preparing-the-land-cover-data" class="level3">
<h3 class="anchored" data-anchor-id="adding-and-preparing-the-land-cover-data">Adding and preparing the land cover data</h3>
<p>Prior to adding the dataset, we had to clip the quarter grid and land cover raster to South Africa’s shape file. From then we projected them to EPSG:4326 (WGS 84) again so that we have consistent scaling. <code>Landcover.csv</code> is the output file from QGIS’s zonal histogram function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Load quarter-degree grid (as polygons)</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>grid <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">"Project_workplan/SA_quart_grid/Clipped_Quarter_Grid.shp"</span>)</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co"># Load land cover raster</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>lc_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Project_workplan/SA_NLC_2020_Geographic.tif.vat/SA_NLC_2020_GEO.tif"</span>)</span>
<span id="cb16-6"><a href="#cb16-6"></a></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co"># Read the lookup table</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>lc_df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Project_workplan/Landcover.csv"</span>)</span>
<span id="cb16-9"><a href="#cb16-9"></a></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="co"># Create a lookup table for land cover classes</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>lc_table <span class="ot">&lt;-</span> <span class="fu">levels</span>(lc_raster)</span>
<span id="cb16-12"><a href="#cb16-12"></a></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co"># save the land cover classes to a CSV file</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="fu">write.csv</span>(lc_table, <span class="st">"landcover_classes.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="grouping-the-land-cover-by-classification-group" class="level3">
<h3 class="anchored" data-anchor-id="grouping-the-land-cover-by-classification-group">Grouping the land cover by classification group</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># Load the land cover classes CSV</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>lc_classes <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"landcover_classes.csv"</span>)</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co"># Initialize vector with default NA or "Other"</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>lc_classes<span class="sc">$</span>SALCC1 <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co"># Assign groups by rows/Values</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>] <span class="ot">&lt;-</span> <span class="st">"Forested land"</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">9</span><span class="sc">:</span><span class="dv">12</span>] <span class="ot">&lt;-</span> <span class="st">"Shrubland"</span></span>
<span id="cb17-10"><a href="#cb17-10"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">13</span><span class="sc">:</span><span class="dv">14</span>] <span class="ot">&lt;-</span> <span class="st">"Grassland"</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">15</span><span class="sc">:</span><span class="dv">22</span>] <span class="ot">&lt;-</span> <span class="st">"Waterbodies"</span></span>
<span id="cb17-12"><a href="#cb17-12"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">23</span><span class="sc">:</span><span class="dv">25</span>] <span class="ot">&lt;-</span> <span class="st">"Wetlands"</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">26</span><span class="sc">:</span><span class="dv">32</span>] <span class="ot">&lt;-</span> <span class="st">"Barren Land"</span></span>
<span id="cb17-14"><a href="#cb17-14"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">33</span><span class="sc">:</span><span class="dv">47</span>] <span class="ot">&lt;-</span> <span class="st">"Cultivated"</span></span>
<span id="cb17-15"><a href="#cb17-15"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">48</span><span class="sc">:</span><span class="dv">68</span>] <span class="ot">&lt;-</span> <span class="st">"Built-up"</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">69</span><span class="sc">:</span><span class="dv">73</span>] <span class="ot">&lt;-</span> <span class="st">"Mines &amp; Quarries"</span></span>
<span id="cb17-17"><a href="#cb17-17"></a>lc_classes<span class="sc">$</span>SALCC1[<span class="dv">74</span>] <span class="ot">&lt;-</span> <span class="st">"Cultivated"</span></span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="fu">write.csv</span>(lc_classes, <span class="st">"landcover_classes_grouped.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pre-process-for-merging-to-environmental-data" class="level3">
<h3 class="anchored" data-anchor-id="pre-process-for-merging-to-environmental-data">Pre-process for merging to environmental data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># Load the new NLC classes CSV</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>nlc_classes <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"landcover_classes_grouped.csv"</span>)</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co"># This grabs all columns that start with "HISTO_"</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>hist_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^HISTO_"</span>, <span class="fu">names</span>(lc_df), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="co"># Extract raster value from histogram column names</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>hist_values <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">sub</span>(<span class="st">"HISTO_"</span>, <span class="st">""</span>, hist_cols))</span>
<span id="cb18-9"><a href="#cb18-9"></a></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co"># Match those to the SALCC1 column by Value</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>class_map <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="at">hist_col =</span> hist_cols,</span>
<span id="cb18-13"><a href="#cb18-13"></a>  <span class="at">value =</span> hist_values,</span>
<span id="cb18-14"><a href="#cb18-14"></a>  <span class="at">class_group =</span> lc_classes<span class="sc">$</span>SALCC1[<span class="fu">match</span>(hist_values, lc_classes<span class="sc">$</span>Value)]</span>
<span id="cb18-15"><a href="#cb18-15"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sum-histogram-by-class-group" class="level3">
<h3 class="anchored" data-anchor-id="sum-histogram-by-class-group">Sum histogram by class group</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Extract just the histogram counts</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>hist_counts <span class="ot">&lt;-</span> lc_df[, hist_cols]</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co"># Assign names to histogram columns as their class groups</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="fu">names</span>(hist_counts) <span class="ot">&lt;-</span> class_map<span class="sc">$</span>class_group</span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co"># convert to matrix</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>hist_counts_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(hist_counts)</span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a>groups <span class="ot">&lt;-</span> class_map<span class="sc">$</span>class_group</span>
<span id="cb19-11"><a href="#cb19-11"></a>unique_groups <span class="ot">&lt;-</span> <span class="fu">unique</span>(groups)</span>
<span id="cb19-12"><a href="#cb19-12"></a></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="co"># Create a list with indices for each group</span></span>
<span id="cb19-14"><a href="#cb19-14"></a>group_indices <span class="ot">&lt;-</span> <span class="fu">lapply</span>(unique_groups, <span class="cf">function</span>(g) <span class="fu">which</span>(groups <span class="sc">==</span> g))</span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="fu">names</span>(group_indices) <span class="ot">&lt;-</span> unique_groups</span>
<span id="cb19-16"><a href="#cb19-16"></a></span>
<span id="cb19-17"><a href="#cb19-17"></a>hist_summarised <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(group_indices, <span class="cf">function</span>(idxs) {</span>
<span id="cb19-18"><a href="#cb19-18"></a>  <span class="fu">rowSums</span>(hist_counts_mat[, idxs, <span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-19"><a href="#cb19-19"></a>}))</span>
<span id="cb19-20"><a href="#cb19-20"></a></span>
<span id="cb19-21"><a href="#cb19-21"></a>hist_summarised <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(hist_summarised)</span>
<span id="cb19-22"><a href="#cb19-22"></a></span>
<span id="cb19-23"><a href="#cb19-23"></a><span class="co"># Add cell_id back</span></span>
<span id="cb19-24"><a href="#cb19-24"></a>hist_summarised<span class="sc">$</span>cell_id <span class="ot">&lt;-</span> lc_df<span class="sc">$</span>id</span>
<span id="cb19-25"><a href="#cb19-25"></a></span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="co"># Reorder so cell_id is first column</span></span>
<span id="cb19-27"><a href="#cb19-27"></a>hist_summarised <span class="ot">&lt;-</span> hist_summarised[, <span class="fu">c</span>(<span class="st">"cell_id"</span>, <span class="fu">setdiff</span>(<span class="fu">names</span>(hist_summarised), <span class="st">"cell_id"</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="add-coordinates-to-land-cover-data" class="level3">
<h3 class="anchored" data-anchor-id="add-coordinates-to-land-cover-data">Add coordinates to land cover data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># Load your grid shapefile</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>grid_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Project_workplan/SA_quart_grid/Clipped_Quarter_Grid.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `Clipped_Quarter_Grid' from data source 
  `C:\Users\pheme\OneDrive\Documents\RStudio\Quantitative_ecology\Project_workplan\SA_quart_grid\Clipped_Quarter_Grid.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1974 features and 7 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 16.45189 ymin: -34.83417 xmax: 32.94498 ymax: -22.12503
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Filter polygons corresponding to your hist_summarised cell_id</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>grid_sel <span class="ot">&lt;-</span> grid_sf[grid_sf<span class="sc">$</span>id <span class="sc">%in%</span> hist_summarised<span class="sc">$</span>cell_id, ]</span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co"># Extract centroids of these polygons</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>centroids <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(grid_sel)</span>
<span id="cb22-6"><a href="#cb22-6"></a></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co"># Add centroid coords to hist_summarised by matching cell_id</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>centroid_coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(centroids)</span>
<span id="cb22-9"><a href="#cb22-9"></a></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co"># Ensure order matches hist_summarised rows</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co"># For safety, order grid_sel by id and hist_summarised by cell_id</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>grid_sel <span class="ot">&lt;-</span> grid_sel[<span class="fu">order</span>(grid_sel<span class="sc">$</span>id), ]</span>
<span id="cb22-13"><a href="#cb22-13"></a>hist_summarised <span class="ot">&lt;-</span> hist_summarised[<span class="fu">order</span>(hist_summarised<span class="sc">$</span>cell_id), ]</span>
<span id="cb22-14"><a href="#cb22-14"></a></span>
<span id="cb22-15"><a href="#cb22-15"></a>hist_summarised<span class="sc">$</span>lon <span class="ot">&lt;-</span> centroid_coords[,<span class="dv">1</span>]</span>
<span id="cb22-16"><a href="#cb22-16"></a>hist_summarised<span class="sc">$</span>lat <span class="ot">&lt;-</span> centroid_coords[,<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="prepare-coordinate-matrices-for-matching" class="level3">
<h3 class="anchored" data-anchor-id="prepare-coordinate-matrices-for-matching">Prepare coordinate matrices for matching</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Add env_df with coordinates</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>env_df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Project_workplan/Env_var.csv"</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co"># Extract coordinates from env_df</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>env_coords <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(env_df[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co"># Extract coordinates from hist_summarised</span></span>
<span id="cb23-8"><a href="#cb23-8"></a>hist_coords <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(hist_summarised[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="find-nearest-neighbour-matches" class="level3">
<h3 class="anchored" data-anchor-id="find-nearest-neighbour-matches">Find nearest neighbour matches</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># For each hist_summarised point, find nearest env_df point index</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>nn_idx <span class="ot">&lt;-</span> <span class="fu">get.knnx</span>(env_coords, hist_coords, <span class="at">k =</span> <span class="dv">1</span>)<span class="sc">$</span>nn.index[,<span class="dv">1</span>]</span>
<span id="cb24-3"><a href="#cb24-3"></a></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co"># Replace or assign IDs in hist_summarised</span></span>
<span id="cb24-5"><a href="#cb24-5"></a></span>
<span id="cb24-6"><a href="#cb24-6"></a>hist_summarised<span class="sc">$</span>cell_id <span class="ot">&lt;-</span> env_df<span class="sc">$</span>cell_id[nn_idx]</span>
<span id="cb24-7"><a href="#cb24-7"></a></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co"># Restore cell ID</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>hist_summarised<span class="sc">$</span>cell_id <span class="ot">&lt;-</span> lc_df<span class="sc">$</span>id</span>
<span id="cb24-10"><a href="#cb24-10"></a></span>
<span id="cb24-11"><a href="#cb24-11"></a>hist_summarised<span class="sc">$</span>original_cell_id <span class="ot">&lt;-</span> lc_df<span class="sc">$</span>id  <span class="co"># This is for traceability</span></span>
<span id="cb24-12"><a href="#cb24-12"></a></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co"># env_coords = matrix of lon/lat from env_df</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>nn_idx <span class="ot">&lt;-</span> <span class="fu">get.knnx</span>(env_coords, hist_coords, <span class="at">k =</span> <span class="dv">1</span>)<span class="sc">$</span>nn.index[,<span class="dv">1</span>]</span>
<span id="cb24-15"><a href="#cb24-15"></a></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co"># Now assign the matched cell_id from env_df to hist_summarised</span></span>
<span id="cb24-17"><a href="#cb24-17"></a>hist_summarised<span class="sc">$</span>cell_id <span class="ot">&lt;-</span> env_df<span class="sc">$</span>cell_id[nn_idx]</span>
<span id="cb24-18"><a href="#cb24-18"></a></span>
<span id="cb24-19"><a href="#cb24-19"></a>hist_summarised <span class="ot">&lt;-</span> hist_summarised <span class="sc">|&gt;</span> </span>
<span id="cb24-20"><a href="#cb24-20"></a>  <span class="fu">select</span>(<span class="sc">-</span>original_cell_id)  <span class="co"># Remove the temporary column</span></span>
<span id="cb24-21"><a href="#cb24-21"></a></span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="co"># Match the rows by removing irrelevant sites</span></span>
<span id="cb24-23"><a href="#cb24-23"></a></span>
<span id="cb24-24"><a href="#cb24-24"></a>env_coords <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(env_df[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</span>
<span id="cb24-25"><a href="#cb24-25"></a>hist_coords <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(hist_summarised[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</span>
<span id="cb24-26"><a href="#cb24-26"></a></span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="co"># For each env site, find the index of the nearest hist_summarised site</span></span>
<span id="cb24-28"><a href="#cb24-28"></a>nn_idx <span class="ot">&lt;-</span> <span class="fu">get.knnx</span>(hist_coords, env_coords, <span class="at">k =</span> <span class="dv">1</span>)<span class="sc">$</span>nn.index[,<span class="dv">1</span>]</span>
<span id="cb24-29"><a href="#cb24-29"></a></span>
<span id="cb24-30"><a href="#cb24-30"></a><span class="co"># Subset and reorder hist_summarised to match env_df</span></span>
<span id="cb24-31"><a href="#cb24-31"></a>hist_matched <span class="ot">&lt;-</span> hist_summarised[nn_idx, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="calculate-proportions" class="level3">
<h3 class="anchored" data-anchor-id="calculate-proportions">Calculate proportions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Remove lon, lat, cell_ID from the columns to calculate proportions</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>lc_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(hist_matched), <span class="fu">c</span>(<span class="st">"cell_id"</span>, <span class="st">"lon"</span>, <span class="st">"lat"</span>))</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co"># Total pixels per site</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>pixel_totals <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(hist_matched[lc_cols], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="co"># Convert to proportions</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>hist_props <span class="ot">&lt;-</span> hist_matched</span>
<span id="cb25-9"><a href="#cb25-9"></a>hist_props[lc_cols] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(hist_props[lc_cols], <span class="cf">function</span>(col) col <span class="sc">/</span> pixel_totals)</span>
<span id="cb25-10"><a href="#cb25-10"></a></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="co"># Check proportions</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="fu">summary</span>(<span class="fu">rowSums</span>(hist_props[lc_cols], <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      1       1       1       1       1       1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Merge it to the environment data frame</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>env_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(env_df, hist_props[, <span class="sc">!</span>(<span class="fu">names</span>(hist_props) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>, <span class="st">"cell_id"</span>))])</span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co"># arrange by cell_ID</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>env_final <span class="ot">&lt;-</span> env_final <span class="sc">|&gt;</span> </span>
<span id="cb27-6"><a href="#cb27-6"></a>  <span class="fu">arrange</span>(cell_id)</span>
<span id="cb27-7"><a href="#cb27-7"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co"># Save as csv</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="fu">write.csv</span>(env_final, <span class="st">"Project_workplan/Num_env_var.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="data-analysis-and-visualisation-kezia-samuels" class="level2">
<h2 class="anchored" data-anchor-id="data-analysis-and-visualisation-kezia-samuels">3. Data analysis and visualisation (Kezia Samuels)</h2>
<section id="load-the-data" class="level3">
<h3 class="anchored" data-anchor-id="load-the-data">Load the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># Environmental data</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>num_env <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Project_workplan/KEZIA/Num_env_var.csv"</span>)</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="fu">View</span>(num_env)</span>
<span id="cb28-4"><a href="#cb28-4"></a></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="co"># Species abundance data </span></span>
<span id="cb28-6"><a href="#cb28-6"></a>adder_abd <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Project_workplan/KEZIA/Adder_Spe_ABD_Clean.csv"</span>)</span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="fu">View</span>(adder_abd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-wrangling" class="level3">
<h3 class="anchored" data-anchor-id="data-wrangling">Data wrangling</h3>
<p>Remove the latitude and longitude columns from the environmental dataset.</p>
<p>Name the rows according to the different cell_IDs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>env <span class="ot">&lt;-</span> num_env <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"lat"</span>, <span class="st">"lon"</span>)) <span class="co"># Remove first two columns (lat and long)</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="fu">View</span>(env)</span>
<span id="cb29-4"><a href="#cb29-4"></a></span>
<span id="cb29-5"><a href="#cb29-5"></a>env <span class="ot">&lt;-</span> env <span class="sc">%&gt;%</span> </span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"cell_ID"</span>)</span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="fu">View</span>(env)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename the rows to the different cell_IDs for the species abundance data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>adder_abd <span class="ot">&lt;-</span> adder_abd <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"cell_id"</span>)</span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="fu">View</span>(adder_abd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="separate-the-environmental-dataset" class="level3">
<h3 class="anchored" data-anchor-id="separate-the-environmental-dataset">Separate the environmental dataset</h3>
<section id="remove-these-variables-from-the-environmental-dataset" class="level4">
<h4 class="anchored" data-anchor-id="remove-these-variables-from-the-environmental-dataset">Remove these variables from the environmental dataset</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>env <span class="ot">&lt;-</span> env <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"Forested land"</span>, <span class="st">"Shrubland"</span>, <span class="st">"Grassland"</span>, <span class="st">"Waterbodies"</span>, <span class="st">"Wetlands"</span>, <span class="st">"Barren Land"</span>, <span class="st">"Cultivated"</span>, <span class="st">"Built-up"</span>, <span class="st">"Mines &amp; Quarries"</span>))</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="fu">View</span>(env)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="correlation-analyses" class="level3">
<h3 class="anchored" data-anchor-id="correlation-analyses">Correlation analyses</h3>
<section id="environmental-variables" class="level4">
<h4 class="anchored" data-anchor-id="environmental-variables">Environmental variables</h4>
<p>Calculate the pearson correlation matrix for the environmental variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>env_corr <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">cor</span>(env), <span class="dv">2</span>)</span>
<span id="cb32-2"><a href="#cb32-2"></a>env_corr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               MeanPrecip DryPrecip WetPrecip SeasonalPrecip Elevation  NDVI
MeanPrecip           1.00      0.42      0.95           0.27      0.20  0.67
DryPrecip            0.42      1.00      0.12          -0.68     -0.28  0.50
WetPrecip            0.95      0.12      1.00           0.54      0.31  0.56
SeasonalPrecip       0.27     -0.68      0.54           1.00      0.33  0.00
Elevation            0.20     -0.28      0.31           0.33      1.00 -0.08
NDVI                 0.67      0.50      0.56           0.00     -0.08  1.00
MeanTemp            -0.04     -0.29      0.06           0.40     -0.58  0.00
MaxTemp             -0.63     -0.54     -0.50           0.22     -0.32 -0.52
MinTemp              0.15      0.30      0.07          -0.13     -0.84  0.31
DiurnalTemp         -0.54     -0.74     -0.35           0.37      0.38 -0.61
               MeanTemp MaxTemp MinTemp DiurnalTemp
MeanPrecip        -0.04   -0.63    0.15       -0.54
DryPrecip         -0.29   -0.54    0.30       -0.74
WetPrecip          0.06   -0.50    0.07       -0.35
SeasonalPrecip     0.40    0.22   -0.13        0.37
Elevation         -0.58   -0.32   -0.84        0.38
NDVI               0.00   -0.52    0.31       -0.61
MeanTemp           1.00    0.66    0.64        0.11
MaxTemp            0.66    1.00    0.07        0.69
MinTemp            0.64    0.07    1.00       -0.61
DiurnalTemp        0.11    0.69   -0.61        1.00</code></pre>
</div>
</div>
<p>Calculate correlation matrix with significance levels</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>env_corr_test <span class="ot">&lt;-</span> <span class="fu">rcorr</span>(<span class="fu">as.matrix</span>(env), <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb34-2"><a href="#cb34-2"></a></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="co"># Extract correlation matrix and p-values</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>corr_matrix <span class="ot">&lt;-</span> env_corr_test<span class="sc">$</span>r</span>
<span id="cb34-5"><a href="#cb34-5"></a>p_values <span class="ot">&lt;-</span> env_corr_test<span class="sc">$</span>P</span>
<span id="cb34-6"><a href="#cb34-6"></a></span>
<span id="cb34-7"><a href="#cb34-7"></a><span class="co"># Create significance level matrix for display</span></span>
<span id="cb34-8"><a href="#cb34-8"></a>sig_matrix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(p_values <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"***"</span>,</span>
<span id="cb34-9"><a href="#cb34-9"></a>                     <span class="fu">ifelse</span>(p_values <span class="sc">&lt;</span> <span class="fl">0.01</span>, <span class="st">"**"</span>,</span>
<span id="cb34-10"><a href="#cb34-10"></a>                            <span class="fu">ifelse</span>(p_values <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Prepare the data for ggplot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>corr_df <span class="ot">&lt;-</span> <span class="fu">melt</span>(corr_matrix)</span>
<span id="cb35-2"><a href="#cb35-2"></a>p_df <span class="ot">&lt;-</span> <span class="fu">melt</span>(p_values)</span>
<span id="cb35-3"><a href="#cb35-3"></a>sig_df <span class="ot">&lt;-</span> <span class="fu">melt</span>(sig_matrix)</span>
<span id="cb35-4"><a href="#cb35-4"></a></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="co"># Combine data</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-7"><a href="#cb35-7"></a>  <span class="at">Var1 =</span> corr_df<span class="sc">$</span>Var1,</span>
<span id="cb35-8"><a href="#cb35-8"></a>  <span class="at">Var2 =</span> corr_df<span class="sc">$</span>Var2,</span>
<span id="cb35-9"><a href="#cb35-9"></a>  <span class="at">correlation =</span> corr_df<span class="sc">$</span>value,</span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="at">p_value =</span> p_df<span class="sc">$</span>value,</span>
<span id="cb35-11"><a href="#cb35-11"></a>  <span class="at">significance =</span> sig_df<span class="sc">$</span>value</span>
<span id="cb35-12"><a href="#cb35-12"></a>)</span>
<span id="cb35-13"><a href="#cb35-13"></a></span>
<span id="cb35-14"><a href="#cb35-14"></a><span class="co"># Create labels combining correlation and significance</span></span>
<span id="cb35-15"><a href="#cb35-15"></a>plot_data<span class="sc">$</span>label <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">round</span>(plot_data<span class="sc">$</span>correlation, <span class="dv">2</span>), </span>
<span id="cb35-16"><a href="#cb35-16"></a>                          <span class="fu">ifelse</span>(plot_data<span class="sc">$</span>significance <span class="sc">!=</span> <span class="st">""</span>, </span>
<span id="cb35-17"><a href="#cb35-17"></a>                                 <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, plot_data<span class="sc">$</span>significance), <span class="st">""</span>))</span>
<span id="cb35-18"><a href="#cb35-18"></a></span>
<span id="cb35-19"><a href="#cb35-19"></a><span class="co"># Add row and column indices for triangle filtering</span></span>
<span id="cb35-20"><a href="#cb35-20"></a>plot_data<span class="sc">$</span>row_idx <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(plot_data<span class="sc">$</span>Var1)</span>
<span id="cb35-21"><a href="#cb35-21"></a>plot_data<span class="sc">$</span>col_idx <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(plot_data<span class="sc">$</span>Var2)</span>
<span id="cb35-22"><a href="#cb35-22"></a></span>
<span id="cb35-23"><a href="#cb35-23"></a><span class="co"># Create upper triangle with diagonal data</span></span>
<span id="cb35-24"><a href="#cb35-24"></a>plot_data_upper_diag <span class="ot">&lt;-</span> plot_data[plot_data<span class="sc">$</span>row_idx <span class="sc">&lt;=</span> plot_data<span class="sc">$</span>col_idx, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot the pearson correlation matrix for the environmental variables</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># Now your plot code:</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="fu">ggplot</span>(plot_data_upper_diag, <span class="fu">aes</span>(<span class="at">x =</span> Var1, <span class="at">y =</span> Var2, <span class="at">fill =</span> correlation)) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> label), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"steelblue"</span>, <span class="at">high =</span> <span class="st">"red"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, </span>
<span id="cb36-6"><a href="#cb36-6"></a>                       <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">limit =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">space =</span> <span class="st">"Lab"</span>,</span>
<span id="cb36-7"><a href="#cb36-7"></a>                       <span class="at">name =</span> <span class="st">"Correlation"</span>) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb36-10"><a href="#cb36-10"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb36-11"><a href="#cb36-11"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb36-12"><a href="#cb36-12"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>  <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="BCB743_Final_Project_files/figure-html/plot-corr-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Correlation matrix of environmental variables. The upper triangle is displayed and shows the Pearson correlation coefficients with significance levels: *** p &lt; 0.001, ** p &lt; 0.01, * p &lt; 0.05. Blue indicates the negative correlations, red indicates the positive correlations. The colour intensity reflects the correlation strength, ranging from -1 to +1.</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="variable-inflation-factor-vif" class="level3">
<h3 class="anchored" data-anchor-id="variable-inflation-factor-vif">Variable Inflation Factor (VIF)</h3>
<p>Check for multicollinearity using VIF for the environmental variables</p>
<p>First remove the minTemp column as this is very strongly correlated with elevation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>mintemp <span class="ot">&lt;-</span> env <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(MinTemp))</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="co"># Check for multicollinearity using VIF</span></span>
<span id="cb37-5"><a href="#cb37-5"></a>vif_result <span class="ot">&lt;-</span> <span class="fu">vifstep</span>(mintemp, <span class="at">th =</span> <span class="dv">10</span>)  <span class="co"># threshold of 10 is common, can also use 5</span></span>
<span id="cb37-6"><a href="#cb37-6"></a></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="co"># See which variables are retained</span></span>
<span id="cb37-8"><a href="#cb37-8"></a>vif_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2 variables from the 9 input variables have collinearity problem: 
 
MeanPrecip MaxTemp 

After excluding the collinear variables, the linear correlation coefficients ranges between: 
min correlation ( NDVI ~ SeasonalPrecip ):  -0.001438219 
max correlation ( DiurnalTemp ~ DryPrecip ):  -0.7391741 

---------- VIFs of the remained variables -------- 
       Variables      VIF
1      DryPrecip 6.527265
2      WetPrecip 6.625295
3 SeasonalPrecip 8.910874
4      Elevation 5.943810
5           NDVI 2.190599
6       MeanTemp 4.511750
7    DiurnalTemp 4.622792</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Get the reduced dataset</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>env_reduced <span class="ot">&lt;-</span> <span class="fu">exclude</span>(mintemp, vif_result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>MeanPrecip and MaxTemp have collinearity issues and are removed from the environmental dataset going forward.</p>
<hr>
</section>
<section id="pca" class="level3">
<h3 class="anchored" data-anchor-id="pca">PCA</h3>
<p>PCA for environmental variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>env_pca <span class="ot">&lt;-</span> <span class="fu">rda</span>(env_reduced, <span class="at">scale =</span> <span class="cn">TRUE</span>) </span>
<span id="cb40-2"><a href="#cb40-2"></a>env_pca</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: rda(X = env_reduced, scale = TRUE)

-- Model Summary --

              Inertia Rank
Total               7     
Unconstrained       7    7

Inertia is correlations

-- Eigenvalues --

Eigenvalues for unconstrained axes:
   PC1    PC2    PC3    PC4    PC5    PC6    PC7 
2.7347 1.9503 1.6165 0.3344 0.2270 0.0825 0.0546 </code></pre>
</div>
</div>
<p>Summary</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">summary</span>(env_pca)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
rda(X = env_reduced, scale = TRUE) 

Partitioning of correlations:
              Inertia Proportion
Total               7          1
Unconstrained       7          1

Eigenvalues, and their contribution to the correlations 

Importance of components:
                         PC1    PC2    PC3     PC4     PC5     PC6      PC7
Eigenvalue            2.7347 1.9503 1.6165 0.33436 0.22704 0.08248 0.054596
Proportion Explained  0.3907 0.2786 0.2309 0.04777 0.03243 0.01178 0.007799
Cumulative Proportion 0.3907 0.6693 0.9002 0.94798 0.98042 0.99220 1.000000</code></pre>
</div>
</div>
<p>Extract species scores for the first two PCA axes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="fu">scores</span>(env_pca, <span class="at">display =</span> <span class="st">"species"</span>, <span class="at">choices =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      PC1        PC2
DryPrecip      -2.8830746  0.3368277
WetPrecip      -0.5693119 -2.9050383
SeasonalPrecip  1.9372495 -2.2482428
Elevation       1.2070069 -1.1275722
NDVI           -2.0491922 -1.8069850
MeanTemp        0.6671760 -0.4765793
DiurnalTemp     2.7856719  0.5918586
attr(,"const")
[1] 8.197179</code></pre>
</div>
</div>
<p>So, the proportion of variation explained by the first PC is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="fu">round</span>(env_pca<span class="sc">$</span>CA<span class="sc">$</span>eig[<span class="dv">1</span>] <span class="sc">/</span> <span class="fu">sum</span>(env_pca<span class="sc">$</span>CA<span class="sc">$</span>eig) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="co"># result in %</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> PC1 
39.1 </code></pre>
</div>
</div>
<p>Therefore, the proportion of variation explained by the first two PCs is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">round</span>(env_pca<span class="sc">$</span>CA<span class="sc">$</span>eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">/</span> <span class="fu">sum</span>(env_pca<span class="sc">$</span>CA<span class="sc">$</span>eig) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="co"># result in %</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> PC1  PC2 
39.1 27.9 </code></pre>
</div>
</div>
<p>PC1 + PC2 = 67%</p>
<p>Import the dataset containing the biome information.</p>
<p>Add biome column to the env dataset so that the sites can be colour-coordinated according to their biomes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>Env_var_clean <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Project_workplan/KEZIA/Env_var_clean.csv"</span>)</span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="fu">View</span>(Env_var_clean)</span>
<span id="cb50-3"><a href="#cb50-3"></a></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="co"># Rename the rows</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>Env_var_clean <span class="ot">&lt;-</span> Env_var_clean <span class="sc">%&gt;%</span> </span>
<span id="cb50-6"><a href="#cb50-6"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"cell_ID"</span>)</span>
<span id="cb50-7"><a href="#cb50-7"></a><span class="fu">View</span>(Env_var_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Copy the “biome” column</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="co"># Simply copy the biome column from one dataset to the other</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>env<span class="sc">$</span>biome <span class="ot">&lt;-</span> Env_var_clean<span class="sc">$</span>biome</span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="fu">View</span>(env)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Biplots</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># Extract PCA scores and loadings</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>site_scores <span class="ot">&lt;-</span> <span class="fu">scores</span>(env_pca, <span class="at">display =</span> <span class="st">"sites"</span>, <span class="at">choices =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a>var_scores <span class="ot">&lt;-</span> <span class="fu">scores</span>(env_pca, <span class="at">display =</span> <span class="st">"species"</span>, <span class="at">choices =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb52-4"><a href="#cb52-4"></a></span>
<span id="cb52-5"><a href="#cb52-5"></a><span class="co"># Create data frames for plotting</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>sites_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb52-7"><a href="#cb52-7"></a>  <span class="at">PC1 =</span> site_scores[, <span class="dv">1</span>],</span>
<span id="cb52-8"><a href="#cb52-8"></a>  <span class="at">PC2 =</span> site_scores[, <span class="dv">2</span>],</span>
<span id="cb52-9"><a href="#cb52-9"></a>  <span class="at">Site =</span> <span class="fu">rownames</span>(site_scores),</span>
<span id="cb52-10"><a href="#cb52-10"></a>  <span class="at">Biome =</span> env<span class="sc">$</span>biome  </span>
<span id="cb52-11"><a href="#cb52-11"></a>)</span>
<span id="cb52-12"><a href="#cb52-12"></a></span>
<span id="cb52-13"><a href="#cb52-13"></a>variables_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb52-14"><a href="#cb52-14"></a>  <span class="at">PC1 =</span> var_scores[, <span class="dv">1</span>],</span>
<span id="cb52-15"><a href="#cb52-15"></a>  <span class="at">PC2 =</span> var_scores[, <span class="dv">2</span>],</span>
<span id="cb52-16"><a href="#cb52-16"></a>  <span class="at">Variable =</span> <span class="fu">rownames</span>(var_scores)</span>
<span id="cb52-17"><a href="#cb52-17"></a>)</span>
<span id="cb52-18"><a href="#cb52-18"></a></span>
<span id="cb52-19"><a href="#cb52-19"></a><span class="co"># Scale down the arrows for better visibility</span></span>
<span id="cb52-20"><a href="#cb52-20"></a>arrow_scale <span class="ot">&lt;-</span> <span class="fl">0.2</span>  <span class="co"># Adjust this value to make arrows shorter/longer</span></span>
<span id="cb52-21"><a href="#cb52-21"></a>variables_df<span class="sc">$</span>PC1_scaled <span class="ot">&lt;-</span> variables_df<span class="sc">$</span>PC1 <span class="sc">*</span> arrow_scale</span>
<span id="cb52-22"><a href="#cb52-22"></a>variables_df<span class="sc">$</span>PC2_scaled <span class="ot">&lt;-</span> variables_df<span class="sc">$</span>PC2 <span class="sc">*</span> arrow_scale</span>
<span id="cb52-23"><a href="#cb52-23"></a></span>
<span id="cb52-24"><a href="#cb52-24"></a><span class="co"># Handle missing biomes</span></span>
<span id="cb52-25"><a href="#cb52-25"></a>sites_df<span class="sc">$</span>Biome[<span class="fu">is.na</span>(sites_df<span class="sc">$</span>Biome)] <span class="ot">&lt;-</span> <span class="st">"Unknown"</span></span>
<span id="cb52-26"><a href="#cb52-26"></a></span>
<span id="cb52-27"><a href="#cb52-27"></a><span class="co"># Calculate variance explained for axis labels</span></span>
<span id="cb52-28"><a href="#cb52-28"></a>var_explained <span class="ot">&lt;-</span> <span class="fu">round</span>(env_pca<span class="sc">$</span>CA<span class="sc">$</span>eig <span class="sc">/</span> <span class="fu">sum</span>(env_pca<span class="sc">$</span>CA<span class="sc">$</span>eig) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb52-29"><a href="#cb52-29"></a></span>
<span id="cb52-30"><a href="#cb52-30"></a><span class="co"># Create the biplot</span></span>
<span id="cb52-31"><a href="#cb52-31"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb52-32"><a href="#cb52-32"></a>  <span class="co"># Add site points colored by biome</span></span>
<span id="cb52-33"><a href="#cb52-33"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> sites_df, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> Biome), </span>
<span id="cb52-34"><a href="#cb52-34"></a>             <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb52-35"><a href="#cb52-35"></a>  </span>
<span id="cb52-36"><a href="#cb52-36"></a>  <span class="co"># Add variable arrows - scaled down</span></span>
<span id="cb52-37"><a href="#cb52-37"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> variables_df, </span>
<span id="cb52-38"><a href="#cb52-38"></a>               <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">xend =</span> PC1_scaled, <span class="at">yend =</span> PC2_scaled),</span>
<span id="cb52-39"><a href="#cb52-39"></a>               <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"cm"</span>)), </span>
<span id="cb52-40"><a href="#cb52-40"></a>               <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb52-41"><a href="#cb52-41"></a>  </span>
<span id="cb52-42"><a href="#cb52-42"></a>  <span class="co"># Add variable labels with better positioning - using scaled coordinates</span></span>
<span id="cb52-43"><a href="#cb52-43"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> variables_df, </span>
<span id="cb52-44"><a href="#cb52-44"></a>                  <span class="fu">aes</span>(<span class="at">x =</span> PC1_scaled, <span class="at">y =</span> PC2_scaled, <span class="at">label =</span> Variable),</span>
<span id="cb52-45"><a href="#cb52-45"></a>                  <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb52-46"><a href="#cb52-46"></a>                  <span class="at">box.padding =</span> <span class="fl">0.5</span>, <span class="at">point.padding =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb52-47"><a href="#cb52-47"></a></span>
<span id="cb52-48"><a href="#cb52-48"></a><span class="co"># Replace your scale_color_manual with:</span></span>
<span id="cb52-49"><a href="#cb52-49"></a><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">qualitative_hcl</span>(<span class="dv">11</span>, <span class="at">palette =</span> <span class="st">"Dark 3"</span>)) <span class="sc">+</span></span>
<span id="cb52-50"><a href="#cb52-50"></a>  </span>
<span id="cb52-51"><a href="#cb52-51"></a>  <span class="co"># Customize the plot</span></span>
<span id="cb52-52"><a href="#cb52-52"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"PC1 ("</span>, var_explained[<span class="dv">1</span>], <span class="st">"%)"</span>),</span>
<span id="cb52-53"><a href="#cb52-53"></a>       <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"PC2 ("</span>, var_explained[<span class="dv">2</span>], <span class="st">"%)"</span>),</span>
<span id="cb52-54"><a href="#cb52-54"></a>       <span class="at">title =</span> <span class="st">"PCA Biplot - Environmental Variables"</span>) <span class="sc">+</span></span>
<span id="cb52-55"><a href="#cb52-55"></a>  </span>
<span id="cb52-56"><a href="#cb52-56"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb52-57"><a href="#cb52-57"></a><span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb52-58"><a href="#cb52-58"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb52-59"><a href="#cb52-59"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb52-60"><a href="#cb52-60"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb52-61"><a href="#cb52-61"></a>      <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb52-62"><a href="#cb52-62"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),  <span class="co"># Remove major gridlines</span></span>
<span id="cb52-63"><a href="#cb52-63"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span> <span class="co"># Remove minor gridlines</span></span>
<span id="cb52-64"><a href="#cb52-64"></a>  </span>
<span id="cb52-65"><a href="#cb52-65"></a>  <span class="co"># Add reference lines</span></span>
<span id="cb52-66"><a href="#cb52-66"></a><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-67"><a href="#cb52-67"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="BCB743_Final_Project_files/figure-html/PCA-biplot-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Principal Component Analysis (PCA) biplot of environmental variables across South African biomes. The different points within the plot represent the different study sites, all of which are categorised by biome type. The blue vectors represent the direction and magnitude of the different environmental variable species scores, and their contribution to the first two principal components.</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="cca" class="level3">
<h3 class="anchored" data-anchor-id="cca">CCA</h3>
<p>Perform the CCA for the environmental variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>cca_result <span class="ot">&lt;-</span> <span class="fu">cca</span>(adder_abd <span class="sc">~</span> ., <span class="at">data =</span> env_reduced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Summary</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="fu">summary</span>(cca_result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
cca(formula = adder_abd ~ DryPrecip + WetPrecip + SeasonalPrecip +      Elevation + NDVI + MeanTemp + DiurnalTemp, data = env_reduced) 

Partitioning of scaled Chi-square:
              Inertia Proportion
Total           6.861     1.0000
Constrained     1.011     0.1474
Unconstrained   5.850     0.8526

Eigenvalues, and their contribution to the scaled Chi-square 

Importance of components:
                         CCA1    CCA2    CCA3     CCA4     CCA5     CCA6
Eigenvalue            0.49620 0.27771 0.12894 0.059672 0.029375 0.015938
Proportion Explained  0.07232 0.04048 0.01879 0.008697 0.004281 0.002323
Cumulative Proportion 0.07232 0.11280 0.13159 0.140286 0.144567 0.146890
                           CCA7    CA1    CA2    CA3     CA4     CA5     CA6
Eigenvalue            0.0032172 0.7947 0.7468 0.6997 0.62809 0.60114 0.55008
Proportion Explained  0.0004689 0.1158 0.1088 0.1020 0.09154 0.08762 0.08017
Cumulative Proportion 0.1473592 0.2632 0.3720 0.4740 0.56556 0.65318 0.73335
                         CA7     CA8     CA9    CA10    CA11
Eigenvalue            0.5071 0.46871 0.37033 0.28024 0.20317
Proportion Explained  0.0739 0.06831 0.05398 0.04084 0.02961
Cumulative Proportion 0.8073 0.87557 0.92954 0.97039 1.00000

Accumulated constrained eigenvalues
Importance of components:
                        CCA1   CCA2   CCA3    CCA4    CCA5    CCA6     CCA7
Eigenvalue            0.4962 0.2777 0.1289 0.05967 0.02938 0.01594 0.003217
Proportion Explained  0.4908 0.2747 0.1275 0.05902 0.02905 0.01576 0.003182
Cumulative Proportion 0.4908 0.7655 0.8930 0.95200 0.98105 0.99682 1.000000</code></pre>
</div>
</div>
<p>Calculate the cumulative proportion of variance explained by the first two canonical axes (CCA1 + CCA2)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="co"># Get eigenvalues</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>eig_vals <span class="ot">&lt;-</span> cca_result<span class="sc">$</span>CCA<span class="sc">$</span>eig</span>
<span id="cb56-3"><a href="#cb56-3"></a></span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="co"># Proportion of variance explained by each canonical axis</span></span>
<span id="cb56-5"><a href="#cb56-5"></a>prop_explained <span class="ot">&lt;-</span> eig_vals <span class="sc">/</span> <span class="fu">sum</span>(eig_vals)</span>
<span id="cb56-6"><a href="#cb56-6"></a></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="co"># Cumulative for first two axes</span></span>
<span id="cb56-8"><a href="#cb56-8"></a>cumulative_CCA1_CCA2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(prop_explained[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb56-9"><a href="#cb56-9"></a></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="co"># Display as percentage</span></span>
<span id="cb56-11"><a href="#cb56-11"></a>cumulative_percentage <span class="ot">&lt;-</span> cumulative_CCA1_CCA2 <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="fu">print</span>(cumulative_percentage)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 76.54508</code></pre>
</div>
</div>
<section id="ordination-plots" class="level4">
<h4 class="anchored" data-anchor-id="ordination-plots">Ordination plots</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># Get site scores</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>site_scores2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">scores</span>(cca_result, <span class="at">scaling =</span> <span class="dv">2</span>, <span class="at">display =</span> <span class="st">"sites"</span>))</span>
<span id="cb58-3"><a href="#cb58-3"></a>site_scores2<span class="sc">$</span>site <span class="ot">&lt;-</span> <span class="fu">rownames</span>(site_scores2)</span>
<span id="cb58-4"><a href="#cb58-4"></a>site_scores2<span class="sc">$</span>biome <span class="ot">&lt;-</span> env<span class="sc">$</span>biome[<span class="fu">match</span>(site_scores2<span class="sc">$</span>site, <span class="fu">rownames</span>(env))]</span>
<span id="cb58-5"><a href="#cb58-5"></a></span>
<span id="cb58-6"><a href="#cb58-6"></a><span class="co"># Get species scores</span></span>
<span id="cb58-7"><a href="#cb58-7"></a>species_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">scores</span>(cca_result, <span class="at">scaling =</span> <span class="dv">2</span>, <span class="at">display =</span> <span class="st">"species"</span>))</span>
<span id="cb58-8"><a href="#cb58-8"></a>species_scores<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="fu">rownames</span>(species_scores)</span>
<span id="cb58-9"><a href="#cb58-9"></a></span>
<span id="cb58-10"><a href="#cb58-10"></a><span class="co"># Get biplot scores (environmental variables)</span></span>
<span id="cb58-11"><a href="#cb58-11"></a>biplot_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">scores</span>(cca_result, <span class="at">scaling =</span> <span class="dv">2</span>, <span class="at">display =</span> <span class="st">"bp"</span>))</span>
<span id="cb58-12"><a href="#cb58-12"></a>biplot_scores<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">rownames</span>(biplot_scores)</span>
<span id="cb58-13"><a href="#cb58-13"></a></span>
<span id="cb58-14"><a href="#cb58-14"></a><span class="co"># SOLUTION 1: Scale up the arrows for better visibility</span></span>
<span id="cb58-15"><a href="#cb58-15"></a>arrow_scale2 <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Adjust this multiplier as needed</span></span>
<span id="cb58-16"><a href="#cb58-16"></a>biplot_scores_scaled <span class="ot">&lt;-</span> biplot_scores</span>
<span id="cb58-17"><a href="#cb58-17"></a>biplot_scores_scaled<span class="sc">$</span>CCA1 <span class="ot">&lt;-</span> biplot_scores<span class="sc">$</span>CCA1 <span class="sc">*</span> arrow_scale2</span>
<span id="cb58-18"><a href="#cb58-18"></a>biplot_scores_scaled<span class="sc">$</span>CCA2 <span class="ot">&lt;-</span> biplot_scores<span class="sc">$</span>CCA2 <span class="sc">*</span> arrow_scale2</span>
<span id="cb58-19"><a href="#cb58-19"></a></span>
<span id="cb58-20"><a href="#cb58-20"></a><span class="co"># SOLUTION 2: Manual label positioning to fix overlaps</span></span>
<span id="cb58-21"><a href="#cb58-21"></a><span class="co"># Start with basic positioning</span></span>
<span id="cb58-22"><a href="#cb58-22"></a>biplot_scores_scaled<span class="sc">$</span>label_x <span class="ot">&lt;-</span> biplot_scores_scaled<span class="sc">$</span>CCA1 <span class="sc">+</span> </span>
<span id="cb58-23"><a href="#cb58-23"></a>  <span class="fl">0.15</span> <span class="sc">*</span> <span class="fu">sign</span>(biplot_scores_scaled<span class="sc">$</span>CCA1) <span class="sc">*</span> (<span class="fu">abs</span>(biplot_scores_scaled<span class="sc">$</span>CCA1) <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(biplot_scores_scaled<span class="sc">$</span>CCA1)))</span>
<span id="cb58-24"><a href="#cb58-24"></a></span>
<span id="cb58-25"><a href="#cb58-25"></a>biplot_scores_scaled<span class="sc">$</span>label_y <span class="ot">&lt;-</span> biplot_scores_scaled<span class="sc">$</span>CCA2 <span class="sc">+</span> </span>
<span id="cb58-26"><a href="#cb58-26"></a>  <span class="fl">0.15</span> <span class="sc">*</span> <span class="fu">sign</span>(biplot_scores_scaled<span class="sc">$</span>CCA2) <span class="sc">*</span> (<span class="fu">abs</span>(biplot_scores_scaled<span class="sc">$</span>CCA2) <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(biplot_scores_scaled<span class="sc">$</span>CCA2)))</span>
<span id="cb58-27"><a href="#cb58-27"></a></span>
<span id="cb58-28"><a href="#cb58-28"></a><span class="co"># Manual adjustments for specific overlapping labels</span></span>
<span id="cb58-29"><a href="#cb58-29"></a><span class="co"># Find the elevation variable and adjust its position</span></span>
<span id="cb58-30"><a href="#cb58-30"></a>elevation_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(biplot_scores_scaled<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"elevation"</span>)</span>
<span id="cb58-31"><a href="#cb58-31"></a><span class="cf">if</span>(<span class="fu">length</span>(elevation_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb58-32"><a href="#cb58-32"></a>  biplot_scores_scaled<span class="sc">$</span>label_y[elevation_idx] <span class="ot">&lt;-</span> biplot_scores_scaled<span class="sc">$</span>label_y[elevation_idx] <span class="sc">+</span> <span class="fl">0.3</span></span>
<span id="cb58-33"><a href="#cb58-33"></a>}</span>
<span id="cb58-34"><a href="#cb58-34"></a></span>
<span id="cb58-35"><a href="#cb58-35"></a><span class="co"># Alternative: Use hjust and vjust based on quadrant</span></span>
<span id="cb58-36"><a href="#cb58-36"></a>biplot_scores_scaled<span class="sc">$</span>hjust <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(biplot_scores_scaled<span class="sc">$</span>CCA1 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb58-37"><a href="#cb58-37"></a>biplot_scores_scaled<span class="sc">$</span>vjust <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(biplot_scores_scaled<span class="sc">$</span>CCA2 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb58-38"><a href="#cb58-38"></a></span>
<span id="cb58-39"><a href="#cb58-39"></a><span class="co"># Get CCA eigenvalues and calculate percentages</span></span>
<span id="cb58-40"><a href="#cb58-40"></a>eigenvalues <span class="ot">&lt;-</span> cca_result<span class="sc">$</span>CCA<span class="sc">$</span>eig</span>
<span id="cb58-41"><a href="#cb58-41"></a>total_inertia <span class="ot">&lt;-</span> <span class="fu">sum</span>(eigenvalues)</span>
<span id="cb58-42"><a href="#cb58-42"></a>cca1_percent <span class="ot">&lt;-</span> <span class="fu">round</span>((eigenvalues[<span class="dv">1</span>] <span class="sc">/</span> total_inertia) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb58-43"><a href="#cb58-43"></a>cca2_percent <span class="ot">&lt;-</span> <span class="fu">round</span>((eigenvalues[<span class="dv">2</span>] <span class="sc">/</span> total_inertia) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb58-44"><a href="#cb58-44"></a></span>
<span id="cb58-45"><a href="#cb58-45"></a><span class="co"># Create the ggplot</span></span>
<span id="cb58-46"><a href="#cb58-46"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb58-47"><a href="#cb58-47"></a>  <span class="co"># Add sites as circles colored by biome</span></span>
<span id="cb58-48"><a href="#cb58-48"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> site_scores2, </span>
<span id="cb58-49"><a href="#cb58-49"></a>             <span class="fu">aes</span>(<span class="at">x =</span> CCA1, <span class="at">y =</span> CCA2, <span class="at">color =</span> biome), </span>
<span id="cb58-50"><a href="#cb58-50"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb58-51"><a href="#cb58-51"></a>  </span>
<span id="cb58-52"><a href="#cb58-52"></a>  <span class="co"># Add species text - back to regular geom_text</span></span>
<span id="cb58-53"><a href="#cb58-53"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> species_scores, </span>
<span id="cb58-54"><a href="#cb58-54"></a>            <span class="fu">aes</span>(<span class="at">x =</span> CCA1, <span class="at">y =</span> CCA2, <span class="at">label =</span> species), </span>
<span id="cb58-55"><a href="#cb58-55"></a>            <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb58-56"><a href="#cb58-56"></a>  </span>
<span id="cb58-57"><a href="#cb58-57"></a>  <span class="co"># Add environmental variable arrows - SCALED UP</span></span>
<span id="cb58-58"><a href="#cb58-58"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> biplot_scores_scaled, </span>
<span id="cb58-59"><a href="#cb58-59"></a>               <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">xend =</span> CCA1, <span class="at">yend =</span> CCA2), </span>
<span id="cb58-60"><a href="#cb58-60"></a>               <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>)), </span>
<span id="cb58-61"><a href="#cb58-61"></a>               <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb58-62"><a href="#cb58-62"></a>  </span>
<span id="cb58-63"><a href="#cb58-63"></a>  <span class="co"># Add environmental variable labels with manual positioning</span></span>
<span id="cb58-64"><a href="#cb58-64"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> biplot_scores_scaled, </span>
<span id="cb58-65"><a href="#cb58-65"></a>            <span class="fu">aes</span>(<span class="at">x =</span> label_x, <span class="at">y =</span> label_y, <span class="at">label =</span> variable,</span>
<span id="cb58-66"><a href="#cb58-66"></a>                <span class="at">hjust =</span> hjust, <span class="at">vjust =</span> vjust), </span>
<span id="cb58-67"><a href="#cb58-67"></a>            <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb58-68"><a href="#cb58-68"></a>  </span>
<span id="cb58-69"><a href="#cb58-69"></a>  <span class="co"># Add reference lines</span></span>
<span id="cb58-70"><a href="#cb58-70"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb58-71"><a href="#cb58-71"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb58-72"><a href="#cb58-72"></a>  </span>
<span id="cb58-73"><a href="#cb58-73"></a>  <span class="co"># Customize the plot with percentages in axis labels</span></span>
<span id="cb58-74"><a href="#cb58-74"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"CCA biplot - Scaling 2"</span>,</span>
<span id="cb58-75"><a href="#cb58-75"></a>       <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"CCA1 ("</span>, cca1_percent, <span class="st">"%)"</span>), </span>
<span id="cb58-76"><a href="#cb58-76"></a>       <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"CCA2 ("</span>, cca2_percent, <span class="st">"%)"</span>),</span>
<span id="cb58-77"><a href="#cb58-77"></a>       <span class="at">color =</span> <span class="st">"Biome"</span>) <span class="sc">+</span></span>
<span id="cb58-78"><a href="#cb58-78"></a>  </span>
<span id="cb58-79"><a href="#cb58-79"></a>  <span class="co"># Use a color palette to match PCA plot</span></span>
<span id="cb58-80"><a href="#cb58-80"></a><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">qualitative_hcl</span>(<span class="dv">11</span>, <span class="at">palette =</span> <span class="st">"Dark 3"</span>)) <span class="sc">+</span></span>
<span id="cb58-81"><a href="#cb58-81"></a>  </span>
<span id="cb58-82"><a href="#cb58-82"></a>  <span class="co"># Clean theme</span></span>
<span id="cb58-83"><a href="#cb58-83"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb58-84"><a href="#cb58-84"></a>  <span class="fu">theme</span>(</span>
<span id="cb58-85"><a href="#cb58-85"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-86"><a href="#cb58-86"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-87"><a href="#cb58-87"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb58-88"><a href="#cb58-88"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb58-89"><a href="#cb58-89"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb58-90"><a href="#cb58-90"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="BCB743_Final_Project_files/figure-html/cca-plot-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Canonical Correspondence Analysis (CCA) biplot illustrating relationships between viper species abundance and environmental variables across South African biomes. The black text represents the viper species, the points represent the different study sites (all of which are categorised by biome type) and the blue vectors represent the respective environmental variables.</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>